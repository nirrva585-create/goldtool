<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XAUUSD Pro Signal + Profit Tools</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    h1 { text-align: center; color: gold; }
    #price { font-size: 3em; text-align: center; margin: 20px 0; }
    .signal { font-size: 2.5em; text-align: center; padding: 20px; border-radius: 10px; margin: 20px 0; font-weight: bold; }
    .buy { background: #0f0; color: black; }
    .sell { background: #f00; color: white; }
    .neutral { background: #555; }
    .info { display: flex; justify-content: space-around; flex-wrap: wrap; }
    .card { background: #222; padding: 15px; border-radius: 8px; margin: 10px; min-width: 280px; text-align: center; }
    .indicator { font-size: 1.2em; margin: 5px; }
    input, button { padding: 8px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #444; padding: 8px; text-align: center; }
    .disclaimer { background: #800; padding: 10px; border-radius: 5px; text-align: center; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>XAUUSD Pro Signal & Profit Tools</h1>
    <div class="disclaimer">⚠️ DISCLAIMER: This is educational/demo only. Trading gold involves high risk of loss. Not financial advice. Backtest & use at your own risk.</div>

    <div id="price">Loading live price...</div>
    <div id="signal" class="signal neutral">Waiting for signal...</div>

    <div class="info">
      <div class="card">
        <h3>Current Price</h3>
        <p id="current-price">-</p>
      </div>
      <div class="card">
        <h3>Indicators</h3>
        <p class="indicator">RSI (14): <span id="rsi">-</span></p>
        <p class="indicator">SMA (50): <span id="sma">-</span></p>
        <p class="indicator">EMA (20): <span id="ema">-</span></p>
        <p class="indicator">BB (20,2): <span id="bb">-</span></p>
      </div>
      <div class="card">
        <h3>TP/SL & Position</h3>
        <p id="buy-tp-sl">-</p>
        <p id="sell-tp-sl">-</p>
      </div>
    </div>

    <div class="card">
      <h3>Position Size Calculator (Risk Management)</h3>
      <label>Account ($): <input id="account" type="number" value="10000"></label><br>
      <label>Risk %: <input id="risk" type="number" value="1" step="0.1"></label><br>
      <label>SL Distance ($/oz): <input id="sldist" type="number" value="10"></label><br>
      <button onclick="calcPosition()">Calculate</button>
      <p id="possize">-</p>
    </div>

    <div style="text-align:center;">
      <button id="enable-alerts">Enable Alerts & Sound</button>
      <button id="toggle-sound">Sound: ON</button>
    </div>

    <!-- Charts -->
    <div class="card" style="width:100%;">
      <h3>XAUUSD Live Chart</h3>
      <div id="tradingview_xau"></div>
    </div>
    <div class="card" style="width:100%;">
      <h3>DXY (USD Index) - Gold Correlation</h3>
      <div id="tradingview_dxy"></div>
    </div>

    <!-- Signal Log -->
    <div class="card">
      <h3>Signal History</h3>
      <table id="signalLog">
        <thead><tr><th>Time</th><th>Price</th><th>Signal</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- News -->
    <div class="card">
      <h3>Gold News (Fundamentals)</h3>
      <iframe src="https://www.investing.com/commodities/gold-news" width="100%" height="400" frameborder="0"></iframe>
      <p>Also check COT Reports for "whale" positioning: <a href="https://www.cftc.gov/MarketReports/CommitmentsofTraders/index.htm" target="_blank">CFTC</a></p>
    </div>
  </div>

  <!-- TradingView Widgets -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script type="text/javascript">
    new TradingView.widget({
      "width": "100%", "height": 500, "symbol": "OANDA:XAUUSD", "interval": "5", "timezone": "Etc/UTC",
      "theme": "dark", "style": "1", "locale": "en", "enable_publishing": false, "container_id": "tradingview_xau"
    });
    new TradingView.widget({
      "width": "100%", "height": 400, "symbol": "TVC:DXY", "interval": "60", "timezone": "Etc/UTC",
      "theme": "dark", "style": "1", "locale": "en", "enable_publishing": false, "container_id": "tradingview_dxy"
    });
  </script>

  <script>
    const API_KEY = 'goldapi-c1v6w5sml0iq8b3-io'; // From https://www.goldapi.io/
    const API_URL = 'https://www.goldapi.io/api/XAU/USD';
    const HEADERS = { 'x-access-token': API_KEY };

    let prevPrice = null;
    let currentPrice = null;
    let signal = 'neutral';
    let priceHistory = []; // For indicators
    let soundEnabled = true;
    let alertsEnabled = false;

    const buyAudio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'); // Buy beep
    const sellAudio = new Audio('https://www.soundjay.com/buttons/beep-02.mp3'); // Sell beep

    async function fetchPrice() {
      try {
        const res = await fetch(API_URL, { headers: HEADERS });
        const data = await res.json();
        if (data.price) {
          currentPrice = data.price;
          document.getElementById('price').innerText = currentPrice.toFixed(2);
          document.getElementById('current-price').innerText = currentPrice.toFixed(2);

          priceHistory.push(currentPrice);
          if (priceHistory.length > 200) priceHistory.shift();

          generateIndicatorsAndSignal();
        } else {
          document.getElementById('price').innerText = 'API Error';
        }
      } catch (err) {
        document.getElementById('price').innerText = 'Fetch Error';
      }
    }

    // Simple indicators
    function calculateSMA(period) {
      if (priceHistory.length < period) return null;
      const slice = priceHistory.slice(-period);
      return slice.reduce((a, b) => a + b, 0) / period;
    }

    let ema20 = null;
    function calculateEMA(price, period = 20) {
      if (!ema20) {
        ema20 = calculateSMA(period); // Initial
        return ema20;
      }
      const multiplier = 2 / (period + 1);
      ema20 = (price * multiplier) + (ema20 * (1 - multiplier));
      return ema20;
    }

    let gains = [], losses = [];
    function calculateRSI(period = 14) {
      if (priceHistory.length < period + 1) return null;
      if (gains.length === 0) {
        for (let i = 1; i <= period; i++) {
          const diff = priceHistory[i] - priceHistory[i-1];
          gains.push(diff > 0 ? diff : 0);
          losses.push(diff < 0 ? -diff : 0);
        }
      } else {
        const diff = priceHistory[priceHistory.length-1] - priceHistory[priceHistory.length-2];
        gains.push(diff > 0 ? diff : 0);
        losses.push(diff < 0 ? -diff : 0);
        if (gains.length > period) gains.shift();
        if (losses.length > period) losses.shift();
      }
      const avgGain = gains.reduce((a,b)=>a+b,0)/period;
      const avgLoss = losses.reduce((a,b)=>a+b,0)/period || 0.0001;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    function calculateBB(period = 20, stdMult = 2) {
      if (priceHistory.length < period) return null;
      const middle = calculateSMA(period);
      const slice = priceHistory.slice(-period);
      const variance = slice.reduce((a,b)=>a + Math.pow(b - middle, 2), 0) / period;
      const std = Math.sqrt(variance);
      return { middle: middle.toFixed(2), upper: (middle + stdMult * std).toFixed(2), lower: (middle - stdMult * std).toFixed(2) };
    }

    function generateIndicatorsAndSignal() {
      if (priceHistory.length < 50) return; // Need data

      const rsi = calculateRSI();
      const sma50 = calculateSMA(50);
      const ema = calculateEMA(currentPrice);
      const bb = calculateBB();

      document.getElementById('rsi').innerText = rsi ? rsi.toFixed(2) : '-';
      document.getElementById('sma').innerText = sma50 ? sma50.toFixed(2) : '-';
      document.getElementById('ema').innerText = ema ? ema.toFixed(2) : '-';
      document.getElementById('bb').innerText = bb ? `${bb.lower} - ${bb.middle} - ${bb.upper}` : '-';

      // Consensus signal (pro-level multi-indicator)
      let buyCount = 0, sellCount = 0;
      if (rsi && rsi < 35) buyCount++; // Oversold
      if (rsi && rsi > 65) sellCount++; // Overbought
      if (sma50 && currentPrice > sma50) buyCount++; else if (sma50) sellCount++;
      if (ema && currentPrice > ema) buyCount++; else if (ema) sellCount++;
      if (bb && currentPrice < bb.lower) buyCount++; // Break below
      if (bb && currentPrice > bb.upper) sellCount++;

      let newSignal = 'neutral';
      if (buyCount >= 3) newSignal = 'buy';
      if (sellCount >= 3) newSignal = 'sell';

      if (newSignal !== signal) {
        signal = newSignal;
        updateUI();
        logSignal();
        if (alertsEnabled) triggerAlert();
      }

      // TP/SL (1:2 RR example)
      const risk = 10; // $ example
      if (signal === 'buy') {
        const entry = currentPrice;
        const sl = entry - risk;
        const tp = entry + (risk * 2);
        document.getElementById('buy-tp-sl').innerText = `Buy Entry: ${entry.toFixed(2)} | TP: ${tp.toFixed(2)} | SL: ${sl.toFixed(2)}`;
      } else document.getElementById('buy-tp-sl').innerText = '-';
      if (signal === 'sell') {
        const entry = currentPrice;
        const sl = entry + risk;
        const tp = entry - (risk * 2);
        document.getElementById('sell-tp-sl').innerText = `Sell Entry: ${entry.toFixed(2)} | TP: ${tp.toFixed(2)} | SL: ${sl.toFixed(2)}`;
      } else document.getElementById('sell-tp-sl').innerText = '-';
    }

    function updateUI() {
      const sigEl = document.getElementById('signal');
      sigEl.innerText = signal.toUpperCase() + ' SIGNAL';
      sigEl.className = 'signal ' + (signal === 'buy' ? 'buy' : signal === 'sell' ? 'sell' : 'neutral');
    }

    function logSignal() {
      const tbody = document.querySelector('#signalLog tbody');
      const row = document.createElement('tr');
      row.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${currentPrice.toFixed(2)}</td><td>${signal.toUpperCase()}</td>`;
      tbody.appendChild(row);
      if (tbody.children.length > 20) tbody.removeChild(tbody.firstChild);
    }

    function triggerAlert() {
      if (Notification.permission === 'granted') {
        new Notification('XAUUSD Signal!', { body: `New ${signal.toUpperCase()} at ${currentPrice.toFixed(2)}` });
      }
      if (soundEnabled) {
        (signal === 'buy' ? buyAudio : sellAudio).play();
      }
    }

    function calcPosition() {
      const acc = parseFloat(document.getElementById('account').value) || 10000;
      const riskPct = parseFloat(document.getElementById('risk').value) / 100 || 0.01;
      const dist = parseFloat(document.getElementById('sldist').value) || 10;
      const riskAmt = acc * riskPct;
      const size = riskAmt / dist; // Units/oz (adjust for broker lot sizing)
      document.getElementById('possize').innerText = `Risk amount: $${riskAmt.toFixed(2)} | Suggested size: ~${size.toFixed(2)} oz (adjust for your broker lot)`;
    }

    // Init
    fetchPrice();
    setInterval(fetchPrice, 60000); // 60s poll (quota-friendly)

    document.getElementById('enable-alerts').onclick = () => {
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') alertsEnabled = true;
        alert('Alerts enabled!');
      });
    };

    document.getElementById('toggle-sound').onclick = () => {
      soundEnabled = !soundEnabled;
      document.getElementById('toggle-sound').innerText = 'Sound: ' + (soundEnabled ? 'ON' : 'OFF');
    };
  </script>
</body>
</html>
