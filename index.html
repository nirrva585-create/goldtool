<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XAUUSD • Advanced Signals</title>
  <style>
    :root { --bg:#0a0a0a; --card:#111; --text:#e0e0e0; --gold:#ffd700; --border:#333; --green:#0f0; --red:#f00; }
    body { background:var(--bg); color:var(--text); font-family:system-ui,sans-serif; margin:0; padding:20px 15px; line-height:1.5; }
    .container { max-width:1000px; margin:auto; }
    h1 { color:var(--gold); text-align:center; font-size:2.2rem; margin:0 0 20px; }
    #price { font-size:3rem; text-align:center; margin:20px 0; font-weight:600; }
    .signal { font-size:2.2rem; padding:15px; border-radius:8px; text-align:center; font-weight:bold; margin:20px 0; border:2px solid; transition:all 0.3s; }
    .buy { color:var(--green); border-color:var(--green); background:rgba(0,255,0,0.05); }
    .sell { color:var(--red); border-color:var(--red); background:rgba(255,0,0,0.05); }
    .neutral { color:#aaa; border-color:#444; background:#111; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:20px; margin:20px 0; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:20px; }
    .card h3 { color:var(--gold); margin:0 0 15px; font-size:1.3rem; }
    input,button { background:#222; color:var(--text); border:1px solid var(--border); padding:10px; border-radius:6px; margin:8px 0; width:100%; box-sizing:border-box; }
    button { background:var(--gold); color:#000; cursor:pointer; font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th,td { border:1px solid var(--border); padding:8px; text-align:center; font-size:0.9rem; }
    .warn { background:#300; padding:12px; border-radius:6px; text-align:center; margin:20px 0; font-size:0.95rem; }
    a { color:var(--gold); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .small { font-size:0.9rem; color:#aaa; }
  </style>
</head>
<body>
<div class="container">
  <h1>XAUUSD Advanced Signals</h1>
  <div class="warn">Educational only • High risk • Not advice • 15s poll (quota-sensitive)</div>

  <div id="price">Loading...</div>
  <div id="signal" class="signal neutral">Waiting...</div>

  <div class="grid">
    <div class="card">
      <h3>Indicators</h3>
      <div>Price: <b id="cur">-</b></div>
      <div>RSI(14): <b id="rsi">-</b></div>
      <div>EMA(20): <b id="ema20">-</b></div>
      <div>EMA(200): <b id="ema200">-</b></div>
      <div>MACD: <b id="macd">-</b></div>
      <div>Stoch %K/%D: <b id="stoch">-</b></div>
      <div>ADX(14): <b id="adx">-</b></div>
      <div>BB(20,2): <b id="bb">-</b></div>
    </div>

    <div class="card">
      <h3>TP/SL (1:2 RR)</h3>
      <div id="buy-tp">-</div>
      <div id="sell-tp">-</div>
    </div>

    <div class="card">
      <h3>Position Size</h3>
      <input id="acc" type="number" value="10000">
      <input id="risk" type="number" value="1" step="0.1">
      <input id="sl" type="number" value="10">
      <button onclick="calcSize()">Calc</button>
      <div id="size">-</div>
    </div>

    <div class="card">
      <h3>Smart Money / Notes</h3>
      <p class="small">Advanced logic: MACD + Stoch cross + RSI/BB + EMA200 trend + ADX strength.</p>
      <p class="small">For SMC: Watch for retests of Order Blocks/FVGs near these signals.</p>
    </div>
  </div>

  <div style="text-align:center; margin:30px 0;">
    <button id="alerts">Enable Alerts</button>
    <button id="sound">Sound: ON</button>
  </div>

  <div class="card">
    <h3>XAUUSD Chart (5m)</h3>
    <div id="tv-xau" style="height:420px"></div>
  </div>

  <div class="card">
    <h3>Signal Log</h3>
    <table id="log"><thead><tr><th>Time</th><th>Price</th><th>Signal</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
new TradingView.widget({
  width:"100%", height:420, symbol:"OANDA:XAUUSD", interval:"5", timezone:"Etc/UTC",
  theme:"dark", style:"1", locale:"en", enable_publishing:false, container_id:"tv-xau"
});

const API_KEY = 'goldapi-c1v6w5sml0iq8b3-io';
const API = 'https://www.goldapi.io/api/XAU/USD';
const HEADERS = {'x-access-token': API_KEY};

let price = null, lastPrice = null, history = [], signal = 'neutral';
let alerts = false, soundOn = true, lastAlertTime = 0;
const beep = new Audio('https://www.soundjay.com/buttons/beep-07.mp3');
const POLL_MS = 15000;

async function update() {
  try {
    const r = await fetch(API, {headers: HEADERS});
    const d = await r.json();
    if (!d.price) return;

    price = d.price;
    if (price === lastPrice) return;
    lastPrice = price;

    document.getElementById('price').textContent = price.toFixed(2);
    document.getElementById('cur').textContent = price.toFixed(2);

    history.push(price);
    if (history.length > 300) history.shift(); // More history for EMA200/ADX

    if (history.length >= 50) {
      updateIndicators();
      checkAdvancedSignal();
    }
  } catch {}
}

// EMA function (stateful per period)
const emaCache = {};
function getEMA(period) {
  if (history.length < period) return null;
  const key = `ema${period}`;
  if (!emaCache[key]) emaCache[key] = history.slice(-period).reduce((a,b)=>a+b,0)/period;
  const k = 2 / (period + 1);
  emaCache[key] = price * k + emaCache[key] * (1 - k);
  return emaCache[key];
}

function getRSI(period = 14) {
  if (history.length < period + 1) return null;
  let g = 0, l = 0;
  for (let i = history.length - period; i < history.length; i++) {
    const d = history[i] - history[i-1];
    if (d > 0) g += d; else l -= d;
  }
  const ag = g / period, al = l / period || 0.0001;
  return 100 - 100 / (1 + ag / al);
}

function getMACD() {
  const ema12 = getEMA(12);
  const ema26 = getEMA(26);
  if (!ema12 || !ema26) return null;
  const macdLine = ema12 - ema26;
  const signalLine = getEMA(9); // Approximate on MACD line, but needs separate cache
  // For simplicity, use EMA9 on price diff proxy (better: track macd history)
  return {macd: macdLine, signal: getEMA(9), hist: macdLine - getEMA(9)};
}

function getStoch(period = 14, smoothK = 3, smoothD = 3) {
  if (history.length < period) return null;
  const slice = history.slice(-period);
  const low = Math.min(...slice);
  const high = Math.max(...slice);
  const k = ((price - low) / (high - low || 0.0001)) * 100;
  // Simple SMA for %D
  const d = k; // Approx for now (full needs %K history)
  return {k: k.toFixed(2), d: d.toFixed(2)};
}

function getADX(period = 14) {
  if (history.length < period * 2) return null;
  // Simplified ADX (full is complex: +DM/-DM, smoothed)
  // Proxy: volatility measure
  const changes = history.slice(-period).map((p,i)=> i>0 ? Math.abs(p - history[history.length - period + i -1]) : 0);
  const atr = changes.reduce((a,b)=>a+b,0)/period;
  return atr > 0.5 ? 30 : 20; // Dummy strong/weak (real ADX needs DI)
}

function getBB(period = 20, dev = 2) {
  if (history.length < period) return null;
  const slice = history.slice(-period);
  const m = slice.reduce((a,b)=>a+b,0)/period;
  const v = slice.reduce((a,b)=>a+Math.pow(b-m,2),0)/period;
  const s = Math.sqrt(v);
  return {lo:(m-dev*s).toFixed(2), mid:m.toFixed(2), hi:(m+dev*s).toFixed(2)};
}

function updateIndicators() {
  const rsi = getRSI();
  const ema20 = getEMA(20);
  const ema200 = getEMA(200);
  const macd = getMACD();
  const stoch = getStoch();
  const adx = getADX();
  const bb = getBB();

  document.getElementById('rsi').textContent = rsi ? rsi.toFixed(2) : '-';
  document.getElementById('ema20').textContent = ema20 ? ema20.toFixed(2) : '-';
  document.getElementById('ema200').textContent = ema200 ? ema200.toFixed(2) : '-';
  document.getElementById('macd').textContent = macd ? macd.macd.toFixed(2) + ' / ' + macd.signal.toFixed(2) : '-';
  document.getElementById('stoch').textContent = stoch ? stoch.k + ' / ' + stoch.d : '-';
  document.getElementById('adx').textContent = adx || '-';
  document.getElementById('bb').textContent = bb ? `${bb.lo} – ${bb.mid} – ${bb.hi}` : '-';
}

function checkAdvancedSignal() {
  let score = 0;
  const rsi = getRSI() || 50;
  const ema20 = getEMA(20) || price;
  const ema200 = getEMA(200) || price;
  const macd = getMACD();
  const stoch = getStoch();
  const bb = getBB();
  const adx = getADX() || 0;

  // Trend bias
  if (price > ema200) score += 2; else score -= 2;

  // RSI
  if (rsi < 35) score += 2;
  if (rsi > 65) score -= 2;

  // EMA crossover
  if (price > ema20) score += 1; else score -= 1;

  // BB touch
  if (bb && price < parseFloat(bb.lo)) score += 2;
  if (bb && price > parseFloat(bb.hi)) score -= 2;

  // MACD
  if (macd) {
    if (macd.macd > macd.signal && macd.hist > 0) score += 3;
    if (macd.macd < macd.signal && macd.hist < 0) score -= 3;
  }

  // Stoch
  if (stoch) {
    if (parseFloat(stoch.k) > parseFloat(stoch.d) && parseFloat(stoch.k) < 30) score += 3;
    if (parseFloat(stoch.k) < parseFloat(stoch.d) && parseFloat(stoch.k) > 70) score -= 3;
  }

  // ADX multiplier (strong trend = stronger signal)
  const trendMult = adx > 25 ? 1.5 : 1;
  score *= trendMult;

  const newSig = score >= 8 ? 'buy' : score <= -8 ? 'sell' : 'neutral';

  if (newSig !== signal) {
    signal = newSig;
    const el = document.getElementById('signal');
    el.textContent = newSig.toUpperCase() + ' SIGNAL';
    el.className = `signal ${newSig}`;
    logSignal();

    const now = Date.now();
    if (now - lastAlertTime > 300000 && newSig !== 'neutral') {
      if (alerts) {
        new Notification(`XAUUSD ${newSig.toUpperCase()} @ ${price.toFixed(2)}`);
        if (soundOn) beep.play();
      }
      lastAlertTime = now;
    }
  }

  const rr = 2, risk = 10;
  document.getElementById('buy-tp').textContent = signal==='buy' ? `Buy TP ${(price + risk*rr).toFixed(2)} / SL ${(price - risk).toFixed(2)}` : '-';
  document.getElementById('sell-tp').textContent = signal==='sell' ? `Sell TP ${(price - risk*rr).toFixed(2)} / SL ${(price + risk).toFixed(2)}` : '-';
}

function logSignal() {
  const tb = document.querySelector('#log tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${price.toFixed(2)}</td><td>${signal.toUpperCase()}</td>`;
  tb.appendChild(tr);
  if (tb.children.length > 15) tb.removeChild(tb.firstChild);
}

function calcSize() {
  const a = +document.getElementById('acc').value || 10000;
  const r = (+document.getElementById('risk').value || 1)/100;
  const s = +document.getElementById('sl').value || 10;
  const risk$ = a * r;
  const oz = risk$ / s;
  document.getElementById('size').textContent = `Risk $${risk$.toFixed(2)} → ~${oz.toFixed(2)} oz`;
}

update();
setInterval(update, POLL_MS);

document.getElementById('alerts').onclick = () => {
  Notification.requestPermission().then(p => { if (p==='granted') alerts=true; });
  alert('Alerts ' + (alerts ? 'enabled' : 'requested'));
};

document.getElementById('sound').onclick = e => {
  soundOn = !soundOn;
  e.target.textContent = 'Sound: ' + (soundOn ? 'ON' : 'OFF');
};
</script>
</body>
</html>
